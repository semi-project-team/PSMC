<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/assets/css/mainpage.css">
</head>
<body>
<th:block th:insert="~{/common/nav}"></th:block>


<div class="mainPage">
    <script>
        const message = `[[${reservationMessage}]]`;
        if(message){
            alert(message);
        }

        const messages = `[[${reservationMessages}]]`;
        if(messages.length>0){
            const m = messages.split(",");
            alert(m.join("\n"));

        }
    </script>


    <th:block th:insert="~{/common/header}"></th:block>
    <div class="container">
        <div class="box1">
            <div class="profile">
                <img src="/common/img/profile.png">
            </div>
            <div class="profile-details">
                <h2 id="profileName" th:text="${profile.name}"></h2>
                <p id="profileNumber">([[${profile.pmCode}]])</p>
                <p id="profilePosition" th:text="${profile.getPositionDTO().getPositionName()}"></p>
                <p id="profileSpecialty" th:text="${profile.getMedicalFieldDTO().getFieldName()}"></p>
                <p id="profilePhoneNumber" th:text="${profile.getOfficeNum()}"></p>
                <p id="profileEmail" th:text="${profile.getEmail()}"></p>

            </div>
        </div>

        <div class="box2">
            <form action="/reservation" method="post" id="formmer">
                <div>
                    <fieldset class="patientinfo">
                        <legend>Patient Info</legend>
                        <table>
                            <tr>
                                <th>환자 이름 : </th>
                                <td>
                                    <select style="border: none" id="patientSelect" name="projectNo">
                                        <option selected disabled>환자를 선택하세요</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>환자 번호 : </th>
                                <td style="text-align: center;" id="patientNo"></td>
                            </tr>
                            <tr>
                                <th>휴대폰 번호 : </th>
                                <td style="text-align: center;" id="patientPhone"></td>
                            </tr>
                        </table>
                    </fieldset>
                </div>

                <script th:inline="javascript">
                    const patients = JSON.parse([[${patient}]]);
                    console.table(patients);
                    const patientSelect =document.getElementById('patientSelect');
                    const patientNo = document.getElementById('patientNo');
                    const patientPhone =document.getElementById('patientPhone');
                    patients.forEach(p=>{
                        const $option = document.createElement('option');
                        $option.value=p.projectNo;
                        $option.textContent=p.patientName;
                        patientSelect.appendChild($option);
                    })

                    patientSelect.addEventListener('change',e=>{
                        const val = patientSelect.value;
                        patients.forEach(p=>{
                            if(p.patientNo == val){
                                patientNo.textContent=p.patientNo;
                                patientPhone.textContent=p.phone;
                            }
                        })

                    })
                </script>

                <div><br>
                    <br>
                    <fieldset class="timeslot" >
                        <legend>TimeSlot</legend>
                        <label sec:authorize="hasAnyAuthority('d')" for="date">날짜 및 시간 :</label>
                        <label for="date" sec:authorize="hasAnyAuthority('t')">날짜 : </label>
                        <input type="date" name="date" id="date">
                        <th:block sec:authorize="hasAnyAuthority('d')">
                            <select name="timeCode" id="time">
                                <option selected disabled value="none">시간을 선택하세요</option>
                                <option value="1">09:00~09:30</option>
                                <option value="2">09:30~10:00</option>
                                <option value="3">10:00~10:30</option>
                                <option value="4">10:30~11:00</option>
                                <option value="5">11:00~11:30</option>
                                <option value="6">11:30~12:00</option>
                                <option value="7">13:00~13:30</option>
                                <option value="8">13:30~14:00</option>
                                <option value="9">14:00~14:30</option>
                                <option value="10">14:30~15:00</option>
                                <option value="11">15:00~15:30</option>
                                <option value="12">15:30~16:00</option>
                                <option value="13">16:00~16:30</option>
                                <option value="14">16:30~17:00</option>
                                <option value="15">17:00~17:30</option>
                                <option value="16">17:30~18:00</option>
                            </select>
                        </th:block>
                        <th:block sec:authorize="hasAnyAuthority('t')">
                            <br>
                            <label for="start">시간 : </label>
                            <input type="time" id="start" name="start" step="60" min="06:00" max="22:00"> ~ <input type="time" id="end" name="end" step="60" min="06:00" max="22:00">
                        </th:block>
                        <br>
                        <script>
                            const $inputDate = document.getElementById('date');
                            const role = `[[${role}]]`;
                            if(role=='d') {
                                resetSelect();

                                patientSelect.addEventListener('change',e=>{
                                    resetSelect();
                                    if($inputDate.value!==""){
                                        checkByPRNo();
                                        checkAllMedi();
                                    }
                                })
                            }
                            $inputDate.addEventListener('change',e=>{

                                if(role == 'd'){
                                    resetSelect();
                                    checkAllMedi();
                                }
                            })

                            function checkByPRNo(){
                                const dateValue = $inputDate.value;
                                if(dateValue!=null) {
                                    fetch("/sendThera", {
                                        method: "POST",
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            projectNo : patientSelect.value,
                                            date : dateValue
                                        })

                                    })
                                        .then(res=>res.json())
                                        .then(data=>{
                                            console.table(data);
                                            if(data!=null){
                                                data.forEach(thera=>{
                                                    if(thera.code!=null){
                                                        thera.code.forEach(c=>{
                                                          const $timeTable = document.getElementById('time');
                                                          $timeTable.querySelector(`option[value="${c}"]`).disabled=true;
                                                        })
                                                    }
                                                })
                                            }

                                        })
                                }
                            }

                            function resetSelect(){
                                const $timeTable = document.getElementById('time');
                                const $option = $timeTable.querySelectorAll('option');
                                $option.forEach(option => {
                                    option.disabled = false;
                                })
                                $option[0].disabled = true;
                            }

                            function checkAllMedi(){
                                const $timeTable = document.getElementById('time');
                                const dateValue = $inputDate.value;
                                fetch("/sendAllMedi",{
                                    method: "POST",
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        selectDate: dateValue
                                    })
                                }).then(res=>res.json())
                                    .then(data=>{
                                        console.table(data);
                                        if(data!=null){
                                            data.forEach(m=>{
                                                const timeCode = m.timeCode;
                                                $timeTable.querySelector(`option[value="${timeCode}"]`).disabled=true;
                                            })
                                        }
                                    })
                                const projectNo = patientSelect.value;
                                if(projectNo!==""){
                                    checkByPRNo();
                                }

                            }
                        </script>
                        <label for="position">증상 및 진단 정보: </label>
                        <textarea name="contents" cols="30" row="60" id="position"></textarea>
                    </fieldset>
                </div>
                <br>
                <span id="inputter">
                        <input type="submit" value="예약">
                        <input type="reset" value="취소" id="cancel">
                        <button id="newProject" sec:authorize="hasAnyAuthority('d')" type="button">New Project</button>
                </span>


            </form>

            <script>
                const $cancel = document.getElementById('cancel');
                $cancel.addEventListener('click',e=>{
                    patientNo.textContent="";
                    patientPhone.textContent="";
                    if(role=='d'){
                        const $timeTable = document.getElementById('time');
                        const $option = $timeTable.querySelectorAll('option');
                        $option.forEach(option => {
                            option.disabled = false;
                        })
                        $option[0].disabled = true;
                    }
                })
            </script>

        </div>
        <div class="box3">
            <fieldset class="timeslot" id="timeslot">
                <legend>Scheduler</legend>
                <!-- <h2>Scheduler</h2> -->
                <div class="schedule-item">
<!--                    <p>24.01.30 (목)</p>-->
                    <p id="today"></p>
                </div>
                <th:block th:if="${projects!=null}">
                    <th:block th:each="project : ${projects}">
                        <div class="schedule-item">
                            <th:block th:if="${role=='d'}">
                                <p th:text="|${project.time[0]} - ${project.time[1]}|"></p>
                                <p th:text="|${project.patientName}(${project.projectNo})|"></p>
                                <p th:text="|부상부위 : ${project.injuryName}|"></p>
                            </th:block>
                            <th:block th:if="${role == 't'}">
                                <p th:text="|${project.start} - ${project.end}|"></p>
                                <p th:text="|${project.patientName}(${project.projectNo})|"></p>
                                <p th:text="|부상부위 : ${project.injuryName}|"></p>
                            </th:block>
                        </div>
                    </th:block>
                </th:block>
                <th:block th:if="${#lists.isEmpty(projects)}">
                    <div class="schedule-item">
                        <p>오늘 일정이 없습니다</p>
                    </div>
                </th:block>
                <script>
                    const $today = document.getElementById('today');
                    const $day = parseInt(`[[${day}]]`.trim());
                    const $date = `[[${ModiToday}]]`;
                    console.log($date+"오늘 날짜");
                    console.log($day);
                    switch($day){
                        case 1:
                            $today.textContent=`${$date} (Sun)`
                            break;
                        case 2:
                            $today.textContent=`${$date} (Mon)`
                            break;
                        case 3:
                            $today.textContent=`${$date} (Tue)`
                            break;
                        case 4:
                            $today.textContent=`${$date} (Wed)`
                            break;
                        case 5:
                            $today.textContent=`${$date} (Thu)`
                            break;
                        case 6:
                            $today.textContent=`${$date} (Fri)`
                            break;
                        case 7:
                            $today.textContent=`${$date} (Sat)`
                            break;
                    }

                </script>

<!--                <div class="schedule-item">-->
<!--                    <p>11:00 - 12:00</p>-->
<!--                    <p>이영희(34725)</p>-->
<!--                    <p>의료 이력: 골절 수술 이력 있음</p>-->
<!--                </div>-->
<!--                <div class="schedule-item">-->
<!--                    <p>13:00 - 14:00</p>-->
<!--                    <p>김진호(35225)</p>-->
<!--                    <p>의료 이력: 특이 사항 없음</p>-->
<!--                </div>-->
                <!-- 기타 스케줄 항목들을 추가할 수 있습니다 -->
            </fieldset>
        </div>


        <div class="box4">
            <div class="title2">Today Menu</div>
            <br>
            <span id="todayCalendar"></span>
            <div id="menuouter" style="width: 100%">
                <button id="leftButton"><i class="fa-solid fa-caret-left" style="color: black"></i></button>
                <div id="todayMenu">
                </div>
                <button id="rightButton"><i class="fa-solid fa-caret-right" style="color: black"></i></button>

            </div>
        </div>

        <script>
            const left = document.getElementById('leftButton');
            const right = document.getElementById('rightButton');
            const todayCalendar = document.getElementById('todayCalendar');
            fetch("/todayMenu")
                .then(res=>res.json())
                .then(data=>{
                    console.table(data);
                    todayCalendar.textContent=data.date
                    makeMenu(data.menuDTO.menuName);
                })

            left.addEventListener('click',e=>{
                fetch("/minusday")
                    .then(res=>res.json())
                    .then(data=>{
                        todayCalendar.textContent=data.date
                        const menuName = data.menuDTO.menuName;
                        makeMenu(menuName);
                    })

            })
            right.addEventListener('click',e=>{
                fetch("/plusday")
                    .then(res=>res.json())
                    .then(data=>{
                        todayCalendar.textContent=data.date;
                        const menuName = data.menuDTO.menuName;
                        makeMenu(menuName);
                    })
            })

            function makeMenu(menuNames){
                const todayMenu = document.getElementById('todayMenu');
                todayMenu.textContent="";
                const menu = menuNames.split(",");
                menu.forEach(m=>{
                    const $p = document.createElement('p');
                    $p.textContent = m;
                    todayMenu.appendChild($p);
                })
            }

        </script>
        <div class="box5">
            <div class="mediconnect">
                <div class="title2">mediconnect</div>
                <div class="button-bar">
                    <button class="button-6">내역 1.김땡땡 오른쪽 무릎 </button><br>
                    <button class="button-6">내역 2.조땡땡 왼쪽 발목 골절</button><br>
                    <button class="button-6">내역 3.박땡땡  ~~~~</button><br>
                    <button class="button-6">내역 4.이떙떙 ~~~~~</button>
                </div>
            </div>
        </div>
        <div class="box6">
            <div class="mediconnect">
                <div class="title2">TheraLink</div>
                <div class="button-bar">
                    <button class="button-6">김땡땡 (23423) 오른쪽 무릎 </button><br>
                    <button class="button-6">조땡땡 (24142)왼쪽 발목 골절</button><br>
                    <button class="button-6">박땡땡 (23424) ~~~~</button><br>
                    <button class="button-6">이떙떙 (24164) ~~~~~</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script src="https://kit.fontawesome.com/56b2fd8c85.js" crossorigin="anonymous"></script>

</html>