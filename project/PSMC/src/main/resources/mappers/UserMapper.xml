<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.javaclass.psmc.user.model.dao.UserMapper">
    <resultMap id="employeeMap" type="com.javaclass.psmc.common.model.dto.EmployeeDTO">
        <id property="pmCode" column="pm_code"/>
        <result property="empNo" column="emp_no"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="name" column="name"/>
        <result property="age" column="age"/>
        <result property="positionCode" column="position_code"/>
        <result property="gender" column="gender"/>
        <result property="officeNum" column="office_num"/>
        <result property="fieldCode" column="field_code"/>
    </resultMap>
    <resultMap id="patientMap" type="com.javaclass.psmc.common.model.dto.PatientDTO">
        <id property="patientNo" column="patient_no"/>
        <result property="patientName" column="patient_name"/>
        <result property="age" column="age"/>
        <result property="gender" column="gender"/>
        <result property="height" column="height"/>
        <result property="weight" column="weight"/>
        <result property="phone" column="phone"/>
        <result property="agree" column="agree"/>
        <result property="email" column="email"/>
    </resultMap>
    <resultMap id="injuryMap" type="com.javaclass.psmc.common.model.dto.InjuryDTO">
        <id property="injuryCode" column="injury_code"/>
        <result property="injuryName" column="injury_name"/>
        <result property="fieldCode" column="field_code"/>
    </resultMap>
    <select id="getAllMember" resultMap="employeeMap">
        select
            *
        from
            employee
    </select>
    <select id="findMember" resultMap="employeeMap" parameterType="hashmap">
        select
            *
        from
            employee
        where
            pm_code = #{pmCode}
        and
            emp_no = #{empNo}
    </select>
    <insert id="registMember" parameterType="com.javaclass.psmc.user.model.dto.SignupDTO"
    useGeneratedKeys="true" keyProperty="registNo">
        insert into
            member_regist
            (id,password,phone,email,birth,employee_status,pm_code,role)
        values
            (#{id},#{password},#{phone},#{email},#{birth},'Y',#{pmCode},#{role})
    </insert>

    <resultMap id="memberMap" type="com.javaclass.psmc.user.model.dto.LoginUserDTO">
        <id property="registNo" column="regist_no"/>
        <result property="id" column="id"/>
        <result property="password" column="password"/>
        <result property="pmCode" column="pm_code"/>
        <result property="userRole" column="role"/>
    </resultMap>
    <select id="findByUsername" resultMap="memberMap" parameterType="string">
        select
            *
        from
            member_regist
        where
            id=#{username}
    </select>


    <select id="findAllMember" resultMap="memberMap">
        select
            *
        from
            member_regist
    </select>

    <select id="findMemberByPmCode" resultMap="memberMap" parameterType="string">
        select
            *
        from
            member_regist
        where
            pm_code = #{pmCode}
    </select>

    <resultMap id="positionMap" type="com.javaclass.psmc.common.model.dto.PositionDTO">
        <id property="positionCode" column="position_code"/>
        <result property="positionName" column="position_name"/>
    </resultMap>
    <resultMap id="medicalFieldMap" type="com.javaclass.psmc.common.model.dto.MedicalFieldDTO">
        <id property="fieldCode" column="field_code"/>
        <result property="fieldName" column="field_name"/>
    </resultMap>

    <resultMap id="profileMap" type="com.javaclass.psmc.mainPage.model.dto.ProfileDTO">
        <id property="pmCode" column="pm_code"/>
        <result property="name" column="name"/>
        <result property="fieldCode" column="field_code"/>
        <result property="positionCode" column="position_code"/>
        <result property="officeNum" column="office_num"/>
        <result property="email" column="email"/>
        <association property="positionDTO" resultMap="positionMap"/>
        <association property="medicalFieldDTO" resultMap="medicalFieldMap"/>
    </resultMap>
    <select id="findEmployeeByPmCode" parameterType="string" resultMap="profileMap">
        select
            a.pm_code,
            a.name,
            a.office_num,
            a.email,
            b.field_name,
            c.position_name
        from
            employee a
        join
            medical_field b on a.field_code = b.field_code
        join
            position c on a.position_code = c.position_code
        where
            a.pm_code = #{pmCode}
    </select>
    <resultMap id="assignMap" type="com.javaclass.psmc.mainPage.model.dto.AssignToEmpDTO">
        <association property="employeeDTO" resultMap="employeeMap"/>
    </resultMap>
    <resultMap id="createMap" type="com.javaclass.psmc.mainPage.model.dto.CreateToEmpDTO">
        <association property="employeeDTO" resultMap="employeeMap"/>
    </resultMap>
    <resultMap id="connectProjectMap" type="com.javaclass.psmc.mainPage.model.dto.ConnectProjectDTO">
        <id property="projectNo" column="project_no"/>
        <association property="create" resultMap="createMap"/>
        <association property="assign" resultMap="assignMap"/>
        <association property="patientDTO" resultMap="patientMap"/>
        <association property="injuryDTO" resultMap="injuryMap"/>
    </resultMap>
    <resultMap id="mediInfoToPro" type="com.javaclass.psmc.mainPage.model.dto.MItoProDTO">
        <id property="mediCode" column="medi_code"/>
        <result property="mediDate" column="medi_date"/>
        <result property="day" column="day"/>
        <association property="connectProjectDTO" resultMap="connectProjectMap"/>
    </resultMap>

    <resultMap id="timeToMediInfoMap" type="com.javaclass.psmc.mainPage.model.dto.TtoMIDTO">
        <id property="timeCode" column="time_code"/>
        <result property="timeVal" column="time_val"/>
        <collection property="mItoProDTOS" resultMap="mediInfoToPro"/>
    </resultMap>
    <select id="todayMedi" parameterType="hashmap" resultMap="timeToMediInfoMap">
        select
            e.pm_code,
            p.patient_name,
            p.age,
            m.medi_date,
            m.medi_code,
            t.time_code,
            t.time_val,
            dayofweek(m.medi_date) as 'day',
            i.injury_name
        from
            res_time t
        join
            medi_info m on t.time_code = m.time_code
        join
            project a on a.project_no = m.project_no
        join
            patient p on p.patient_no = a.patient_no
        join
            create_project c on c.project_no = a.project_no
        join
            employee e on e.pm_code = c.pm_code
        join
            injury i on i.injury_code = a.injury_code
        where
            e.pm_code = #{pmCode}
        and
            m.medi_date between #{startDay} and #{endDay}
        and
            m.medi_status='Y'
        and
            a.project_status='Y'
        order by
            t.time_val;

    </select>

    <select id="allTimes" resultMap="timeToMediInfoMap" parameterType="string">
        select
            e.pm_code,
            p.patient_name,
            m.medi_date,
            m.medi_code,
            t.time_code,
            t.time_val,
            a.project_no
        from
            res_time t
        join
            medi_info m on t.time_code = m.time_code
        join
            project a on a.project_no = m.project_no
        join
            patient p on p.patient_no = a.patient_no
        join
            create_project c on c.project_no = a.project_no
        join
            employee e on e.pm_code = c.pm_code
        join
            injury i on i.injury_code = a.injury_code
        where
            e.pm_code = #{pmCode}
        and
            medi_status='Y'
        and
            a.project_status = 'Y'
    </select>

    <update id="softDelete" parameterType="HashMap">
        update
        <if test="role == 'doctor'">
                medi_info
            set
                medi_status ='N'
            where
                medi_code = #{code}
        </if>
        <if test="role == 'thera'">
                thera_info
            set
                thera_status = 'N'
            where
                thera_code = #{code}

        </if>
    </update>
    <update id="mediInfoUpdate" parameterType="hashmap">
        update
        <if test="role == 'doctor'">
            medi_info
        </if>
        <if test="role == 'thera'">
            thera_info
        </if>

        set
            project_no=#{projectNo},
        <if test="role == 'doctor'">
                medi_date = #{mediDate},
                time_code = #{timeCode}
            where
                medi_code = #{code}
        </if>
        <if test="role == 'thera'">
                thera_date = #{mediDate},
                start = #{start},
                end = #{end}
            where
                thera_code = #{code}
        </if>


    </update>

    <resultMap id="theraToPro" type="com.javaclass.psmc.mainPage.model.dto.TheraToProDTO">
        <id property="theraCode" column="thera_code"/>
        <result property="theraDate" column="thera_date"/>
        <result property="start" column="start"/>
        <result property="end" column="end"/>
        <result property="day" column="day"/>
        <association property="connectProjectDTO" resultMap="connectProjectMap"/>
    </resultMap>

    <select id="todayThera" parameterType="hashmap" resultMap="theraToPro">
        select
            t.thera_code,
            t.thera_date,
            t.start,
            t.end,
            dayofweek(t.thera_date) as 'day',
            a.project_no,
            i.injury_name,
            e.pm_code,
            p.patient_name,
            p.age
        from
            thera_info t
        join
            project a on t.project_no = a.project_no
        join
            injury i on i.injury_code = a.injury_code
        join
            assign_project s on s.project_no = a.project_no
        join
            employee e on e.pm_code = s.pm_code
        join
            patient p on p.patient_no = a.patient_no
        where
            e.pm_code = #{pmCode}
<!--        and-->
<!--            t.thera_date between #{startDay} and #{endDay}-->
<!--        데이터 사이즈가 작아서 잠시 주석 처리-->
        and
            a.project_status = 'Y'
        and
            t.thera_status = 'Y'
        order by
            t.start

    </select>

    <select id="allThera" resultMap="theraToPro" parameterType="string">
        select
            t.thera_code,
            t.thera_date,
            t.start,
            t.end,
            dayofweek(t.thera_date) as 'day',
            a.project_no,
            i.injury_name,
            e.pm_code,
            p.patient_name,
            p.age
        from
            thera_info t
        join
            project a on t.project_no = a.project_no
        join
            injury i on i.injury_code = a.injury_code
        join
            assign_project s on s.project_no = a.project_no
        join
            employee e on e.pm_code = s.pm_code
        join
            patient p on p.patient_no = a.patient_no
        where
            e.pm_code = #{pmCode}
        and
            a.project_status='Y'
        and
            t.thera_status = 'Y'
        order by
            t.start
    </select>
    <resultMap id="mediInfoMap" type="com.javaclass.psmc.common.model.dto.MediInfoDTO">
        <id property="mediCode" column="medi_code"/>
        <result property="mediDate" column="medi_date"/>
        <result property="projectNo" column="project_no"/>
        <result property="timeCode" column="time_code"/>
        <result property="mediRegDate" column="medi_reg_date"/>
        <result property="mediStatus" column="medi_status"/>
    </resultMap>
    <resultMap id="theraInfoMap" type="com.javaclass.psmc.common.model.dto.TheraInfoDTO">
        <id property="theraCode" column="thera_code"/>
        <result property="theraDate" column="thera_date"/>
        <result property="projectNo" column="project_no"/>
        <result property="theraRegDate" column="thera_reg_date"/>
        <result property="theraStatus" column="thera_status"/>
        <result property="start" column="start"/>
        <result property="end" column="end"/>
    </resultMap>


    <resultMap id="allMediMap" type="com.javaclass.psmc.mainPage.model.dto.AllMediDTO">
        <result property="projectNo" column="project_no"/>
        <collection property="mediInfoDTOS" resultMap="mediInfoMap"/>
    </resultMap>

    <select id="allMedi" resultMap="allMediMap" parameterType="hashmap">
        select
            a.project_no,
            m.time_code,
            m.medi_date
        from
            project a

        <if test="role == 'doctor'">
            join
                create_project c on c.project_no = a.project_no
            join
                employee e on e.pm_code = c.pm_code
        </if>
        <if test="role == 'thera'">
            join
                assign_project s on s.project_no = a.project_no
            join
                employee e on e.pm_code = s.pm_code
        </if>
        join medi_info m
        on
            m.project_no = a.project_no
        where
            e.pm_code = #{pmCode}

    </select>
    <resultMap id="allTheraMap" type="com.javaclass.psmc.mainPage.model.dto.AllTheraDTO">
        <result property="projectNo" column="project_no"/>
        <collection property="theraInfoDTOS" resultMap="theraInfoMap"/>
    </resultMap>
    <select id="allTheraInfo" resultMap="allTheraMap" parameterType="hashmap">
        select
            a.project_no,
            t.start,
            t.end,
            t.thera_date
        from
            project a
        <if test="role == 'doctor'">
            join
                create_project c on c.project_no=a.project_no
            join
                employee e on e.pm_code = c.pm_code
        </if>
        <if test="role == 'thera'">
            join
                assign_project s on s.project_no = a.project_no
            join
                employee e on e.pm_code = s.pm_code
        </if>
        join
            thera_info t on t.project_no = a.project_no
        where
            e.pm_code = #{pmCode}
    </select>

    <select id="checkRes" resultMap="connectProjectMap" parameterType="hashmap">
        select
            a.project_no
        from
            project a
        join
            assign_project s on a.project_no = s.project_no
        join
            employee e on e.pm_code = s.pm_code
        join
            medi_info m on m.project_no = a.project_no
        join
            res_time r on r.time_code = m.time_code
        where
            m.medi_date = #{mediDate}
        and
            r.time_val between #{start} and #{end}
        and
            m.medi_status = 'Y'
    </select>
    <select id="tcheckRes" resultMap="connectProjectMap" parameterType="hashmap">
        select
            a.project_no
        from
            project a
        join
            assign_project s on s.project_no = a.project_no
        join
            employee e on e.pm_code = s.pm_code
        join
            thera_info t on t.project_no = a.project_no
        where
            t.thera_date = #{medi_date}
        and
            <![CDATA[
                t.start > #{start}
            or
                t.end < #{end}]]>
        and
            t.thera_status  = 'Y'


    </select>
    <resultMap id="resTimeMap" type="com.javaclass.psmc.common.model.dto.ResTimeDTO">
        <id property="timeCode" column="time_code"/>
        <result property="timeVal" column="time_val"/>
    </resultMap>

    <resultMap id="mainPageScheduleMap" type="com.javaclass.psmc.auth.model.dto.ProjectsDTO">
        <id property="projectNo" column="project_no"/>
        <result property="patientName" column="patient_name"/>
        <result property="injuryName" column="injury_name"/>
        <result property="day" column="day"/>
        <association property="resTimeDTOS" resultMap="resTimeMap"/>
    </resultMap>
    <select id="mediToday" resultMap="mainPageScheduleMap" parameterType="hashmap">
        select
            t.time_val,
            p.patient_name,
            a.project_no,
            i.injury_name,
            dayofweek(m.medi_date) as 'day'
        from
            project a
        join
            create_project c
        on
            c.project_no = a.project_no
        join
            medi_info m
        on
            m.project_no = a.project_no
        join
            res_time t
        on
            t.time_code = m.time_code
        join
            patient p
        on
            p.patient_no = a.patient_no
        join
            injury i
        on
            i.injury_code = a.injury_code
        where
            c.pm_code = #{pmCode}
        and
            m.medi_date = #{today}
        and
            a.project_status = 'Y'
        and
            m.medi_status = 'Y'
        order by
            t.time_val
    </select>

    <resultMap id="menuMap" type="com.javaclass.psmc.common.model.dto.MenuDTO">
        <id property="dayNo" column="day_no"/>
        <result property="menuName" column="menu_name"/>
    </resultMap>
    <select id="menu" resultMap="menuMap" parameterType="string">
        select
            *
        from
            menu
        where
            day_no = dayofweek(#{date})
    </select>

    <select resultType="int" id="findDayNo" parameterType="string">
        select
            dayofweek(#{today})

    </select>
    <resultMap id="theraTodayMap" type="com.javaclass.psmc.auth.model.dto.TheraProjectDTO">
        <result property="start" column="start"/>
        <result property="end" column="end"/>
        <result property="patientName" column="patient_name"/>
        <result property="projectNo" column="project_no"/>
        <result property="injuryName" column="injury_name"/>
        <result property="theraDate" column="thera_date"/>
    </resultMap>
    
    <select id="theraToday" resultMap="theraTodayMap" parameterType="hashmap">
        select
            t.start,
            t.end,
            p.patient_name,
            a.project_no,
            i.injury_name,
            t.thera_date
        from
            project a
        join
            thera_info t
        on
            a.project_no = t.project_no
        join
            injury i
        on
            i.injury_code = a.injury_code
        join
            assign_project s
        on
            s.project_no = a.project_no
        join
            patient p
        on
            p.patient_no = a.patient_no
        where
            t.thera_date = #{today}
        and
            s.pm_code = #{pmCode}
        and
            t.thera_status='Y'
        and
            a.project_status='Y'
    </select>
</mapper>